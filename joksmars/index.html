<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebGIS Rute Fasilitas Terdekat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
          
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        /* Memastikan peta mengisi seluruh tinggi layar */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', sans-serif;
        }
        
        #map {
            height: 100vh;
        }
        
        /* Kustomisasi style untuk Leaflet UI agar konsisten dengan Tailwind */
        .leaflet-control-layers,
        .leaflet-bar,
        .leaflet-routing-container {
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
            border: none;
        }
        
        .leaflet-routing-container {
            background-color: white;
        }

        .leaflet-bar a {
            border: none;
        }
        
        .leaflet-bar a:first-child {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .leaflet-bar a:last-child {
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }
        
        /* Style untuk Tombol Reset/Home Kustom */
        .custom-reset-button {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px; /* Sedikit lebih lebar untuk konsistensi */
            height: 30px;
            font-size: 1.2rem;
            line-height: 30px;
            background-color: #fff;
            cursor: pointer;
        }
        .custom-reset-button:hover {
            background-color: #f4f4f4;
        }
        .custom-reset-button svg {
            width: 18px;
            height: 18px;
            fill: #333;
        }

        /* Tombol kustom di dalam popup */
        .rute-btn {
            background-color: #3b82f6; /* bg-blue-500 */
            color: white;
            padding: 0.25rem 0.75rem; /* py-1 px-3 */
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 600; /* font-semibold */
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .rute-btn:hover {
            background-color: #2563eb; /* bg-blue-600 */
        }
        
        .rute-btn-pendidikan {
            background-color: #10b981; /* bg-emerald-500 */
        }
        .rute-btn-pendidikan:hover {
            background-color: #059669; /* bg-emerald-600 */
        }
    </style>
</head>
<body class="overflow-hidden">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-full sm:w-1/3 md:w-1/4 lg:w-1/5 h-full bg-gray-50 border-r border-gray-200 p-4 overflow-y-auto shadow-lg z-10">
            <h1 class="text-xl font-bold text-gray-800 mb-4">WebGIS Fasilitas</h1>
            <p class="text-sm text-gray-600 mb-6">
                Sistem informasi geografis untuk menampilkan rute terdekat dari titik sampel ke fasilitas kesehatan atau pendidikan.
            </p>

            <!-- Legenda -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Legenda</h2>
                <ul class="space-y-2 text-sm">
                    <li class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-red-500 mr-2 border border-red-700"></span> Titik Sampel
                    </li>
                    <li class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-blue-500 mr-2 border border-blue-700"></span> Fas. Kesehatan
                    </li>
                    <li class="flex items-center">
                        <span class="w-4 h-4 rounded-full bg-emerald-500 mr-2 border border-emerald-700"></span> Fas. Pendidikan
                    </li>
                    <li class="flex items-center">
                        <span class="w-4 h-4 bg-gray-300 opacity-70 mr-2 border border-gray-500"></span> Area Administrasi
                    </li>
                </ul>
            </div>
            
            <!-- Informasi -->
            <div class="text-xs text-gray-500">
                <h3 class="font-semibold mb-2">Cara Penggunaan:</h3>
                <ol class="list-decimal list-inside space-y-1">
                    <li>Gunakan kontrol layer di pojok kanan atas.</li>
                    <li>Klik pada <strong>Titik Sampel</strong> (merah).</li>
                    <li>Klik tombol "Cari Rute" di popup.</li>
                    <li>Gunakan tombol <strong>Home</strong> (di atas zoom) untuk reset peta.</li>
                </ol>
            </div>
            
        </div>

        <!-- Map Container -->
        <div id="map" class="flex-1"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // --- DATA MOCKUP GEOJSON ---
        // Ganti variabel ini dengan data GeoJSON Anda (bisa juga di-load via fetch)
        
        // Data Area Administrasi (Polygon)
        const adminData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": { "NAMA": "Area Administrasi Contoh" },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [110.30, -7.80],
                            [110.45, -7.80],
                            [110.45, -7.90],
                            [110.30, -7.90],
                            [110.30, -7.80]
                        ]]
                    }
                }
            ]
        };

        // Data Fasilitas Kesehatan (Titik)
        const fasilitasKesehatanData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": { "NAMA": "RS. Harapan Sehat", "TIPE": "Rumah Sakit" },
                    "geometry": { "type": "Point", "coordinates": [110.35, -7.83] }
                },
                {
                    "type": "Feature",
                    "properties": { "NAMA": "Klinik Medika", "TIPE": "Klinik" },
                    "geometry": { "type": "Point", "coordinates": [110.42, -7.85] }
                },
                {
                    "type": "Feature",
                    "properties": { "NAMA": "Puskesmas Jaya", "TIPE": "Puskesmas" },
                    "geometry": { "type": "Point", "coordinates": [110.38, -7.88] }
                }
            ]
        };

        // Data Fasilitas Pendidikan (Titik)
        const fasilitasPendidikanData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": { "NAMA": "Universitas Belajar", "TIPE": "Universitas" },
                    "geometry": { "type": "Point", "coordinates": [110.32, -7.82] }
                },
                {
                    "type": "Feature",
                    "properties": { "NAMA": "SMA Negeri 100", "TIPE": "SMA" },
                    "geometry": { "type": "Point", "coordinates": [110.40, -7.82] }
                },
                {
                    "type": "Feature",
                    "properties": { "NAMA": "SDN Pelita", "TIPE": "SD" },
                    "geometry": { "type": "Point", "coordinates": [110.43, -7.88] }
                }
            ]
        };

        // Data Titik Sampel (Titik)
        // Properti "tipe" SANGAT PENTING. Ini menentukan rute akan dicari ke mana.
        const titikSampelData = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": { "ID": "S-001", "tipe": "kesehatan" },
                    "geometry": { "type": "Point", "coordinates": [110.33, -7.85] }
                },
                {
                    "type": "Feature",
                    "properties": { "ID": "S-002", "tipe": "pendidikan" },
                    "geometry": { "type": "Point", "coordinates": [110.36, -7.87] }
                },
                {
                    "type": "Feature",
                    "properties": { "ID": "S-003", "tipe": "kesehatan" },
                    "geometry": { "type": "Point", "coordinates": [110.41, -7.81] }
                },
                {
                    "type": "Feature",
                    "properties": { "ID": "S-004", "tipe": "pendidikan" },
                    "geometry": { "type": "Point", "coordinates": [110.44, -7.86] }
                }
            ]
        };

        // --- INISIALISASI PETA LEAFLET ---
        
        // Simpan view awal
        const initialCenter = [-7.85, 110.38];
        const initialZoom = 12;

        document.addEventListener('DOMContentLoaded', function () {
            // Inisialisasi Peta
            const map = L.map('map').setView(initialCenter, initialZoom);

            // Base Maps
            const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            // Variabel global untuk menyimpan layer
            let fasilitasKesehatanLayer;
            let fasilitasPendidikanLayer;
            let routingControl = null; // Variabel untuk menyimpan kontrol rute

            // --- Fungsi untuk membuat Ikon Kustom ---
            function createCustomIcon(color) {
                const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" width="28px" height="28px" style="stroke: #ffffff; stroke-width: 1.5; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));">
                    <path d="M12 2C7.58 2 4 5.58 4 10c0 5.25 8 12 8 12s8-6.75 8-12C20 5.58 16.42 2 12 2zm0 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                </svg>`;
                
                return L.divIcon({
                    html: svgIcon,
                    className: 'custom-div-icon',
                    iconSize: [28, 28],
                    iconAnchor: [14, 28], // Ujung bawah tengah
                    popupAnchor: [0, -28]
                });
            }

            const iconKesehatan = createCustomIcon('#3b82f6'); // blue-500
            const iconPendidikan = createCustomIcon('#10b981'); // emerald-500
            const iconSampel = createCustomIcon('#ef4444'); // red-500

            // --- Memuat Layer GeoJSON ---

            // 1. Area Administrasi
            const adminLayer = L.geoJSON(adminData, {
                style: {
                    color: "#4b5563", // gray-600
                    weight: 2,
                    opacity: 0.8,
                    fillColor: "#d1d5db", // gray-300
                    fillOpacity: 0.5
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`<strong>Area:</strong> ${feature.properties.NAMA}`);
                }
            }).addTo(map);

            // 2. Fasilitas Kesehatan
            fasilitasKesehatanLayer = L.geoJSON(fasilitasKesehatanData, {
                pointToLayer: function (feature, latlng) {
                    return L.marker(latlng, { icon: iconKesehatan });
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`<strong>${feature.properties.NAMA}</strong><br>Tipe: ${feature.properties.TIPE}`);
                }
            }).addTo(map);

            // 3. Fasilitas Pendidikan
            fasilitasPendidikanLayer = L.geoJSON(fasilitasPendidikanData, {
                pointToLayer: function (feature, latlng) {
                    return L.marker(latlng, { icon: iconPendidikan });
                },
                onEachFeature: function (feature, layer) {
                    layer.bindPopup(`<strong>${feature.properties.NAMA}</strong><br>Tipe: ${feature.properties.TIPE}`);
                }
            }).addTo(map);

            // 4. Titik Sampel (Dengan Logika Rute)
            const sampelLayer = L.geoJSON(titikSampelData, {
                pointToLayer: function (feature, latlng) {
                    const props = feature.properties;
                    const isKesehatan = props.tipe === 'kesehatan';
                    const targetType = isKesehatan ? 'Kesehatan' : 'Pendidikan';
                    const btnClass = isKesehatan ? 'rute-btn' : 'rute-btn rute-btn-pendidikan';

                    // Buat konten popup dengan tombol
                    const popupContent = `
                        <strong>ID Sampel: ${props.ID}</strong><br>
                        Target: Fasilitas ${targetType}<br><br>
                        <button class="${btnClass}" 
                                data-lat="${latlng.lat}" 
                                data-lng="${latlng.lng}" 
                                data-tipe="${props.tipe}">
                            Cari Rute Terdekat
                        </button>
                    `;
                    
                    return L.marker(latlng, { icon: iconSampel }).bindPopup(popupContent);
                }
            }).addTo(map);

            // --- Kontrol Layer ---
            const baseMaps = {
                "OpenStreetMap": osm,
                "Satelit": satellite
            };

            const overlayMaps = {
                "Area Administrasi": adminLayer,
                "Fasilitas Kesehatan": fasilitasKesehatanLayer,
                "Fasilitas Pendidikan": fasilitasPendidikanLayer,
                "Titik Sampel": sampelLayer
            };

            L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

            // --- TOMBOL RESET VIEW (HOME) KUSTOM ---
            const ResetControl = L.Control.extend({
                options: {
                    position: 'topleft' // Posisi di atas tombol zoom
                },
                onAdd: function (map) {
                    // Buat container
                    const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
                    // Buat tombol
                    const button = L.DomUtil.create('a', 'custom-reset-button', container);
                    // SVG Ikon Home (Material Design Icon)
                    button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"/></svg>';
                    button.href = '#';
                    button.role = 'button';
                    button.title = 'Reset View';

                    // Hentikan propagasi event klik agar tidak 'terklik' ke peta
                    L.DomEvent.disableClickPropagation(button);
                    L.DomEvent.on(button, 'click', function (e) {
                        L.DomEvent.stop(e);
                        
                        // 1. Kembalikan view peta
                        map.setView(initialCenter, initialZoom);
                        
                        // 2. Hapus rute jika ada
                        if (routingControl) {
                            map.removeControl(routingControl);
                            routingControl = null;
                        }
                    });

                    return container;
                }
            });
            // Tambahkan kontrol kustom ke peta
            map.addControl(new ResetControl());


            // --- Logika FUNGSI RUTE ---
            
            // 1. Fungsi untuk mencari fasilitas terdekat
            function findClosestFacility(sampleLatLng, tipe) {
                let targetLayer = (tipe === 'kesehatan') ? fasilitasKesehatanLayer : fasilitasPendidikanLayer;
                let minDistance = Infinity;
                let closestFacility = null;

                targetLayer.eachLayer(function(layer) {
                    const facilityLatLng = layer.getLatLng();
                    const distance = sampleLatLng.distanceTo(facilityLatLng); // Jarak garis lurus
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestFacility = layer;
                    }
                });
                
                return closestFacility; // Mengembalikan layer marker fasilitas
            }

            // 2. Fungsi untuk membuat rute
            function createRoute(fromLatLng, toLatLng) {
                // Hapus rute sebelumnya jika ada
                if (routingControl) {
                    map.removeControl(routingControl);
                }

                // Buat rute baru
                routingControl = L.Routing.control({
                    waypoints: [
                        fromLatLng,
                        toLatLng
                    ],
                    routeWhileDragging: false,
                    addWaypoints: false,
                    draggableWaypoints: false,
                    show: true, // Tampilkan panel instruksi rute
                    fitSelectedRoutes: true,
                    lineOptions: {
                        styles: [{ color: '#2563eb', opacity: 0.8, weight: 6 }]
                    },
                    // Menggunakan OSRM demo server
                    serviceUrl: 'https://router.project-osrm.org/route/v1' 
                }).addTo(map);
            }

            // 3. Event listener pada map untuk menangani klik tombol di popup (Event Delegation)
            map.on('popupopen', function (e) {
                const btn = e.popup._container.querySelector('.rute-btn');
                if (btn) {
                    btn.addEventListener('click', function () {
                        const lat = this.dataset.lat;
                        const lng = this.dataset.lng;
                        const tipe = this.dataset.tipe;

                        const fromLatLng = L.latLng(lat, lng);
                        
                        // Cari fasilitas terdekat
                        const closest = findClosestFacility(fromLatLng, tipe);
                        
                        if (closest) {
                            const toLatLng = closest.getLatLng();
                            
                            // Buat rute
                            createRoute(fromLatLng, toLatLng);
                            
                            // Tutup popup
                            map.closePopup();
                            
                            // Info di console
                            console.log(`Rute dibuat dari [${lat}, ${lng}] ke fasilitas terdekat di [${toLatLng.lat}, ${toLatLng.lng}]`);
                            console.log(closest.feature.properties);

                        } else {
                            console.error("Tidak ada fasilitas yang ditemukan untuk tipe: " + tipe);
                            // Gunakan modal kustom, tapi untuk sekarang kita kembalikan alert
                            // agar pengguna tahu ada masalah.
                            alert("Maaf, tidak ada fasilitas yang ditemukan.");
                        }
                    });
                }
            });

        }); // Akhir DOMContentLoaded
    </script>
</body>
</html>

