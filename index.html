<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Geografis Kecamatan Serengan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        #map { height: 100%; width: 100%; border-radius: 0.5rem; z-index: 1; }
        
        .nav-btn.active { background-color: #0F172A; color: #38BDF8; border-left: 4px solid #38BDF8; }
        .nav-btn:hover:not(.active) { background-color: #E2E8F0; color: #0F172A; }

        /* Toast & Legend */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; font-size: 0.875rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out; display: flex; align-items: center; min-width: 250px; }
        .toast-success { background-color: #10B981; } .toast-error { background-color: #EF4444; } .toast-info { background-color: #3B82F6; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .legend { line-height: 24px; color: #333; background: white; padding: 14px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-family: 'Inter', sans-serif; font-size: 13px; min-width: 200px; }
        .legend h4 { font-weight: 700; margin: 0 0 10px; color: #475569; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 10px; opacity: 0.9; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        .legend-row { clear: both; margin-bottom: 6px; display: flex; align-items: center; }

        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* Sembunyikan panel instruksi rute default Leaflet Routing Machine */
        .leaflet-routing-container { display: none; }

        /* Style untuk Tombol Reset Kustom */
        .custom-reset-btn {
            background-color: white;
            width: 34px;
            height: 34px;
            border-radius: 4px;
            border: 2px solid rgba(0,0,0,0.2);
            box-shadow: 0 1px 5px rgba(0,0,0,0.65);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .custom-reset-btn:hover { background-color: #f4f4f4; }
        .custom-reset-btn i { font-size: 16px; color: #333; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">

    <div id="toast-container"></div>

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 hidden md:flex shadow-xl">
        <div class="h-16 flex items-center px-6 border-b border-slate-100 bg-slate-50">
            <i class="fas fa-map-location-dot text-blue-600 text-xl mr-3"></i>
            <span class="font-bold text-lg tracking-tight text-slate-800">SIG SERENGAN</span>
        </div>
        <nav class="flex-1 py-6 space-y-1 px-3">
            <p class="px-3 text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Menu Utama</p>
            <button onclick="switchView('map')" id="btn-map" class="nav-btn active w-full flex items-center px-3 py-3 rounded-md text-sm font-medium transition-colors"><i class="fas fa-globe-asia w-6 text-center text-lg mr-2"></i> Peta Sebaran</button>
            <button onclick="switchView('dashboard')" id="btn-dashboard" class="nav-btn w-full flex items-center px-3 py-3 rounded-md text-sm font-medium text-slate-500 transition-colors"><i class="fas fa-chart-line w-6 text-center text-lg mr-2"></i> Dashboard Data</button>
            
            <div class="mt-8">
                <p class="px-3 text-xs font-bold text-slate-400 uppercase mb-3 tracking-wider">Layer Peta</p>
                <div class="px-3 space-y-3 text-sm text-slate-600">
                    <!-- 1. Batas Kelurahan (PINK) -->
                    <div class="flex items-center cursor-pointer hover:text-pink-600 transition" onclick="toggleLayer('batas')">
                        <span class="w-3 h-3 rounded-full border border-pink-500 bg-pink-100 mr-3" style="border-width: 2px;"></span> Batas Kelurahan
                    </div>
                    <!-- 2. Nilai Bidang Tanah (Choropleth/Orange-Red) -->
                    <div class="flex items-center cursor-pointer hover:text-orange-600 transition" onclick="toggleLayer('nbt')">
                        <span class="w-3 h-3 rounded-full bg-gradient-to-br from-yellow-300 to-red-600 mr-3 border border-gray-300"></span> Nilai Bidang Tanah
                    </div>
                    <!-- 3. Zona Nilai Tanah (Hijau Transparan) -->
                    <div class="flex items-center cursor-pointer hover:text-green-600 transition" onclick="toggleLayer('znt')">
                        <span class="w-3 h-3 rounded-full bg-green-500 bg-opacity-50 mr-3 border border-green-600"></span> Zona Nilai Tanah
                    </div>
                    <!-- 4. Jaringan Jalan (Abu Gelap) -->
                    <div class="flex items-center cursor-pointer hover:text-gray-700 transition" onclick="toggleLayer('jalan')">
                        <span class="w-3 h-3 rounded-full bg-gray-700 mr-3 border border-gray-800"></span> Jaringan Jalan
                    </div>
                    <!-- 5. Titik Sampel & Rute (Ungu/Merah Titik) -->
                    <div class="flex items-center cursor-pointer hover:text-purple-600 transition mt-4 pt-4 border-t" onclick="toggleLayer('analisis')">
                        <div class="relative w-3 h-3 mr-3">
                            <span class="absolute w-3 h-3 rounded-full bg-red-600 border border-white"></span>
                        </div>
                        Titik Sampel & Rute
                    </div>
                </div>
            </div>
        </nav>
        <div class="p-4 border-t border-slate-100 bg-slate-50 text-xs text-slate-500 text-center">
            &copy; 2025 Kecamatan Serengan
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed top-0 w-full bg-white border-b border-slate-200 z-50 h-16 flex items-center justify-between px-4 shadow-sm">
        <div class="flex items-center"><i class="fas fa-map-location-dot text-blue-600 mr-2"></i><span class="font-bold text-slate-800">SIG SERENGAN</span></div>
        <button onclick="alert('Gunakan Desktop Mode untuk tampilan optimal')" class="text-slate-500"><i class="fas fa-bars text-xl"></i></button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 relative bg-slate-100 mt-16 md:mt-0 overflow-hidden">
        
        <!-- MAP VIEW -->
        <div id="view-map" class="absolute inset-0 p-3 md:p-4 h-full flex flex-col">
            <div class="relative w-full h-full bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                <div id="map"></div>
                <!-- Info Panel untuk Analisis Rute -->
                <div id="route-info" class="absolute bottom-5 left-5 z-[500] bg-white/90 backdrop-blur p-4 rounded-lg shadow-lg border border-slate-200 hidden max-w-sm transition-all duration-300">
                    <div class="flex justify-between items-center mb-3 border-b pb-2">
                        <h4 class="font-bold text-slate-800 text-sm"><i class="fas fa-directions text-blue-500 mr-2"></i>Rute Terdekat</h4>
                        <button onclick="resetApp()" class="text-gray-400 hover:text-red-500 text-xs font-bold border border-gray-300 px-2 py-1 rounded">Tutup & Reset</button>
                    </div>
                    <ul class="text-xs space-y-3" id="route-details"></ul>
                </div>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="absolute inset-0 p-4 md:p-8 h-full hidden overflow-y-auto custom-scroll">
            <header class="mb-8 flex justify-between items-end">
                <div><h1 class="text-2xl font-bold text-slate-800">Dashboard Statistik</h1><p class="text-slate-500 text-sm mt-1">Analisis Data Wilayah & Lingkungan</p></div>
                <button onclick="reloadCharts()" class="bg-white hover:bg-slate-50 text-slate-600 border border-slate-300 px-4 py-2 rounded shadow-sm text-sm font-medium transition"><i class="fas fa-sync-alt mr-2 text-blue-500"></i> Refresh Data</button>
            </header>

            <!-- STATS CARDS -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between"><div><p class="text-xs font-bold text-slate-400 uppercase">Total Kelurahan</p><h3 class="text-2xl font-bold text-slate-800">7</h3></div><i class="fas fa-map text-blue-200 text-3xl"></i></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between"><div><p class="text-xs font-bold text-slate-400 uppercase">Zona Nilai</p><h3 class="text-2xl font-bold text-slate-800">12</h3></div><i class="fas fa-layer-group text-green-200 text-3xl"></i></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between"><div><p class="text-xs font-bold text-slate-400 uppercase">Bidang Tanah</p><h3 class="text-2xl font-bold text-slate-800">2.4K+</h3></div><i class="fas fa-home text-orange-200 text-3xl"></i></div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between"><div><p class="text-xs font-bold text-slate-400 uppercase">Avg Suhu</p><h3 class="text-2xl font-bold text-slate-800">29°C</h3></div><i class="fas fa-temperature-high text-red-200 text-3xl"></i></div>
            </div>

            <!-- CHARTS GRID -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-10">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-700 mb-4 text-sm flex items-center border-b pb-2"><i class="fas fa-chart-pie mr-2 text-blue-500"></i> Proporsi Jumlah Bidang Tanah</h3><div class="h-64 relative flex justify-center"><canvas id="chartBidang"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-700 mb-4 text-sm flex items-center border-b pb-2"><i class="fas fa-tags mr-2 text-green-500"></i> Nilai Tanah per Zona (NTZ)</h3><div class="h-64 relative"><canvas id="chartNTZ"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-700 mb-4 text-sm flex items-center border-b pb-2"><i class="fas fa-city mr-2 text-indigo-500"></i> Nilai Tanah per Kelurahan (NTK)</h3><div class="h-64 relative"><canvas id="chartNTK"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200"><h3 class="font-bold text-slate-700 mb-4 text-sm flex items-center border-b pb-2"><i class="fas fa-user-secret mr-2 text-slate-700"></i> Statistik Kejahatan</h3><div class="h-64 relative"><canvas id="chartKejahatan"></canvas></div></div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 lg:col-span-2"><h3 class="font-bold text-slate-700 mb-4 text-sm flex items-center border-b pb-2"><i class="fas fa-temperature-low mr-2 text-red-500"></i> Tren Suhu Rata-rata Bulanan</h3><div class="h-64 relative w-full"><canvas id="chartSuhu"></canvas></div></div>
            </div>
        </div>
    </main>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // --- 1. UTILS ---
        function showToast(msg, type='info') {
            const el = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'} mr-2"></i> ${msg}`;
            el.appendChild(toast);
            setTimeout(() => { toast.style.opacity='0'; setTimeout(()=>toast.remove(),300); }, 3000);
        }
        function formatRupiah(num) { 
            if(num === null || num === undefined || isNaN(num)) return "Rp 0";
            return new Intl.NumberFormat('id-ID', {style:'currency', currency:'IDR', minimumFractionDigits:0}).format(num); 
        }

        // --- 2. MAP SETUP & RESET CONTROL ---
        const initialView = { lat: -7.575, lng: 110.825, zoom: 14 }; 
        const map = L.map('map').setView([initialView.lat, initialView.lng], initialView.zoom);
        
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'],
            attribution: '&copy; Google Maps'
        }).addTo(map);

        // Custom Reset Control
        const ResetControl = L.Control.extend({
            options: { position: 'topleft' },
            onAdd: function(map) {
                const btn = L.DomUtil.create('div', 'custom-reset-btn leaflet-bar');
                btn.innerHTML = '<i class="fas fa-home" title="Reset View & Clear Routes"></i>';
                btn.onclick = function(e) {
                    L.DomEvent.stopPropagation(e);
                    resetApp();
                };
                return btn;
            }
        });
        map.addControl(new ResetControl());

        function resetApp() {
            map.setView([initialView.lat, initialView.lng], initialView.zoom);
            resetRoutes();
            document.getElementById('route-info').classList.add('hidden');
            showToast("Peta di-reset ke awal", "info");
        }

        // Z-INDEX PANE (URUTAN LAYER)
        // Semakin kecil angka, semakin bawah layer digambar
        map.createPane('paneBatas').style.zIndex = 350; // PALING BAWAH
        map.createPane('paneZNT').style.zIndex = 400; 
        map.createPane('paneNBT').style.zIndex = 450;
        map.createPane('paneJalan').style.zIndex = 490; // Di atas polygon, di bawah titik

        // --- 3. SYMBOLOGY ---
        const grades = [4000000, 5250000, 6500000, 7500000, 9000000, 12000000, 15000000, 23000000];
        function getColor(d) {
            return d <= grades[0] ? '#1a9850' : d <= grades[1] ? '#66bd63' : d <= grades[2] ? '#a6d96a' : d <= grades[3] ? '#d9ef8b' : d <= grades[4] ? '#fee08b' : d <= grades[5] ? '#fdae61' : d <= grades[6] ? '#f46d43' : '#d73027';
        }

        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = '<h4>NBT / m²</h4>';
            for (let i=0; i<grades.length; i++) div.innerHTML += `<div class="legend-row"><i style="background:${getColor(grades[i])}"></i><span class="legend-label">&lt; ${formatRupiah(grades[i])}</span></div>`;
            return div;
        };
        legend.addTo(map);

        // --- 4. DATA LOADING & LAYERS ---
        const layers = { 
            batas: L.featureGroup(), 
            nbt: L.featureGroup(), 
            znt: L.featureGroup(),
            jalan: L.featureGroup(), 
            titikSampel: L.featureGroup(),
            transport: L.featureGroup(),
            kesehatan: L.featureGroup(),
            pendidikan: L.featureGroup(),
            ruteLines: L.featureGroup().addTo(map)
        };

        let routingControls = []; 

        async function loadGeoJSON(url, layerGroup, name, valField, paneName) {
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                const opts = {
                    onEachFeature: (f, l) => {
                        let content = `<div class="text-sm font-sans"><h4 class="font-bold border-b pb-1 mb-2 text-blue-600">${name}</h4><table class="w-full">`;
                        
                        // POPUP: Tampilkan Nilai Utama di Atas (displayField)
                        if(valField && f.properties[valField] !== undefined) {
                            let val = f.properties[valField];
                            // Cek jika val adalah angka untuk diformat rupiah
                            if (!isNaN(parseFloat(val))) val = formatRupiah(val);
                            
                            content += `<tr class="bg-blue-50"><td class="text-gray-600 text-xs uppercase font-bold py-1">${valField}</td><td class="font-bold text-blue-700 text-right">${val}</td></tr>`;
                        }

                        let count=0;
                        for(let k in f.properties){ 
                            if(count<6 && k !== valField){ // Jangan duplikat display field
                                let v=f.properties[k]; 
                                if(k==='PREDICTED' || k==='NBT') v=formatRupiah(v); // Auto format currency
                                content+=`<tr><td class="text-gray-500 text-xs uppercase pr-2">${k}</td><td class="font-medium text-right">${v}</td></tr>`; 
                            } 
                            count++; 
                        }
                        l.bindPopup(content+"</table></div>");
                    }
                };
                
                if (paneName) opts.pane = paneName;
                
                opts.style = (f) => {
                    let val = null;
                    if (valField && f.properties[valField]) {
                        val = f.properties[valField];
                        // Auto-clean currency/string to number
                        if (typeof val === 'string') val = parseInt(val.replace(/[^0-9]/g, ''), 10);
                    }

                    // Jika nilai valid, klasifikasikan warna
                    if (val && !isNaN(val)) {
                        return { fillColor: getColor(val), weight:1, opacity:1, color:'white', dashArray:'3', fillOpacity:0.75 };
                    }
                    
                    // Fallback style (untuk ZNT yang sekarang jadi background)
                    return { color:'#10b981', fillColor: '#10b981', weight:1, opacity:1, fillOpacity:0.15, dashArray:'' }; 
                };

                L.geoJSON(data, opts).addTo(layerGroup);
                layerGroup.addTo(map);
            } catch(e) { console.error("Error load " + name, e); }
        }

        // LOAD BATAS KELURAHAN (STYLE BARU: PINK + FILL 15% + PANE PALING BAWAH)
        async function loadBatasKelurahan() {
            try {
                const res = await fetch('Data/BatasKelurahan.geojson');
                if(!res.ok) throw new Error("Gagal load BatasKelurahan");
                const data = await res.json();
                L.geoJSON(data, {
                    style: {
                        color: '#ff1493', // DeepPink Border
                        weight: 3,        
                        opacity: 1,
                        fillColor: '#ff1493', // DeepPink Fill
                        fillOpacity: 0.15,    // 15% Transparency
                        dashArray: null       // Solid Line
                    },
                    pane: 'paneBatas', // Z-INDEX 350
                    onEachFeature: (f, l) => l.bindPopup(`<b>Batas Wilayah</b><br>${f.properties.NAMOBJ || 'Kelurahan'}`)
                }).addTo(layers.batas);
                layers.batas.addTo(map);
            } catch(e) { console.error("Batas Error", e); }
        }

        async function loadRoadVisual() {
            try {
                const res = await fetch('Data/Jalan.geojson');
                const data = await res.json();
                L.geoJSON(data, { 
                    style: { color: '#374151', weight: 2, opacity: 0.8 }, 
                    pane: 'paneJalan' 
                }).addTo(layers.jalan);
                layers.jalan.addTo(map);
            } catch(e) { console.error("Gagal load Jalan", e); }
        }

        // --- 5. LOGIKA RUTE & POPUP ---
        let rawFacilities = { transport: null, kesehatan: null, pendidikan: null };

        function getFeatureName(props, preferredKey) {
            if (props[preferredKey]) return props[preferredKey];
            const keys = Object.keys(props);
            const normalizedPreferred = preferredKey.toLowerCase().replace(/ /g, '');
            const match = keys.find(k => k.toLowerCase().replace(/_/g, '').replace(/ /g, '') === normalizedPreferred);
            if (match) return props[match];
            const fallbacks = ['NAMOBJ', 'Nama', 'NAME', 'Name', 'Keterangan', 'REMARK', 'Label'];
            for (const fb of fallbacks) { if (props[fb]) return props[fb]; }
            return "Nama Tidak Tersedia";
        }

        async function loadFacilityData(url, layerGroup, facType) {
            try {
                const res = await fetch(url);
                const data = await res.json();
                rawFacilities[facType] = data; 

                let preferredKey = 'NAMOBJ';
                let label = 'Fasilitas';
                if (facType === 'kesehatan') { preferredKey = 'Nama'; label = 'Fasilitas Kesehatan'; }
                else if (facType === 'pendidikan') { preferredKey = 'Nama Sekolah'; label = 'Fasilitas Pendidikan'; }
                else if (facType === 'transport') { preferredKey = 'Nama Transportasi Umum'; label = 'Transportasi Publik'; }

                L.geoJSON(data, {
                    pointToLayer: (f, latlng) => {
                        const color = facType === 'transport' ? 'blue' : (facType === 'kesehatan' ? 'green' : 'orange');
                        return L.circleMarker(latlng, { radius: 8, fillColor: color, color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.9 });
                    },
                    onEachFeature: (f, l) => {
                        const name = getFeatureName(f.properties, preferredKey);
                        l.bindPopup(`<div style='text-align:center;'><b>${label}</b><br>${name}</div>`);
                    }
                }).addTo(layerGroup);
            } catch(e) { console.error(`Gagal load ${facType}`, e); }
        }

        function resetRoutes() {
            for (const control of routingControls) { map.removeControl(control); }
            routingControls = [];
            document.getElementById('route-details').innerHTML = '';
        }

        function createRoute(fromLatLng, toLatLng, color) {
            const routeControl = L.Routing.control({
                waypoints: [fromLatLng, toLatLng],
                show: false, addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true,
                lineOptions: { styles: [{ color: color, opacity: 0.8, weight: 6 }] },
                serviceUrl: 'https://router.project-osrm.org/route/v1' 
            }).addTo(map);
            routingControls.push(routeControl);
        }

        function handleSampelClick(fromLatLng) {
            resetRoutes();
            document.getElementById('route-info').classList.remove('hidden');
            const types = [
                { type: 'transport', label: 'Transportasi', color: '#3b82f6', layer: layers.transport, nameKey: 'Nama Transportasi Umum' },
                { type: 'kesehatan', label: 'Kesehatan', color: '#10b981', layer: layers.kesehatan, nameKey: 'Nama' },
                { type: 'pendidikan', label: 'Pendidikan', color: '#eab308', layer: layers.pendidikan, nameKey: 'Nama Sekolah' }
            ];
            let infoHTML = "";
            types.forEach(fac => {
                let minDist = Infinity; let nearest = null; let nearestName = "Tidak diketahui";
                if (rawFacilities[fac.type]) {
                    L.geoJSON(rawFacilities[fac.type]).eachLayer(layer => {
                        const dist = fromLatLng.distanceTo(layer.getLatLng());
                        if (dist < minDist) { minDist = dist; nearest = layer.getLatLng(); nearestName = getFeatureName(layer.feature.properties, fac.nameKey); }
                    });
                }
                if (nearest) {
                    createRoute(fromLatLng, nearest, fac.color);
                    infoHTML += `<li class="border-b border-gray-100 pb-2"><div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-700 text-xs flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: ${fac.color}"></span>${fac.label}</span></div><div class="text-xs text-gray-600 mb-1 truncate">${nearestName}</div><div class="text-[10px] text-gray-400">Jarak lurus: ±${Math.round(minDist)} m</div></li>`;
                }
            });
            document.getElementById('route-details').innerHTML = infoHTML;
        }

        async function loadSampelPoints() {
            try {
                const res = await fetch('Data/TitikSampel.geojson');
                const data = await res.json();
                L.geoJSON(data, {
                    pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 10, fillColor: "#DC2626", color: "#fff", weight: 3, opacity: 1, fillOpacity: 1 }),
                    onEachFeature: (f, l) => {
                        l.bindPopup("<b>Titik Sampel</b><br>Klik untuk cari rute.");
                        l.on('click', (e) => handleSampelClick(e.latlng));
                    }
                }).addTo(layers.titikSampel);
                layers.titikSampel.addTo(map);
            } catch(e){}
        }

        // EKSEKUSI
        loadBatasKelurahan(); 
        
        // ZNT: Simple Style (valField = null) -> Background Hijau
        loadGeoJSON('Data/ZNTBARU_FeaturesToJSON.geojson', layers.znt, 'Zona Nilai', null, 'paneZNT');
        
        // NBT: Classified Style -> Pass "NBT" sebagai valField
        loadGeoJSON('Data/NBTLAYER_FeaturesToJSON.geojson', layers.nbt, 'Nilai Bidang Tanah', 'NBT', 'paneNBT');
        
        loadRoadVisual();
        loadFacilityData('Data/Transportasi.geojson', layers.transport, 'transport');
        loadFacilityData('Data/Kesehatan.geojson', layers.kesehatan, 'kesehatan');
        loadFacilityData('Data/Pendidikan.geojson', layers.pendidikan, 'pendidikan');
        loadSampelPoints();

        const overlayLayers = {
            "Batas Kelurahan": layers.batas, "Zona Nilai (ZNT)": layers.znt, "Bidang Tanah (NBT)": layers.nbt, "Jaringan Jalan": layers.jalan, 
            "Titik Sampel": layers.titikSampel, "Fasilitas Transportasi": layers.transport, "Fasilitas Kesehatan": layers.kesehatan, "Fasilitas Pendidikan": layers.pendidikan
        };
        L.control.layers(null, overlayLayers, {position:'topright', collapsed: false}).addTo(map);

        layers.analisis = L.layerGroup([layers.titikSampel, layers.transport, layers.kesehatan, layers.pendidikan]);

        // CHARTS LOGIC (UNCHANGED)
        let chartsLoaded = false; const chartInstances = {};
        function cleanCurrency(val) { if (typeof val === 'number') return val; if (typeof val === 'string') return parseInt(val.replace(/[^0-9]/g, ''), 10); return 0; }
        function detectKeys(data) { if(!data||data.length===0)return{label:null,value:null}; const k=Object.keys(data[0]); return {label:['Nama_Kelurahan','Kelurahan','Zona_ID','Jenis_Kejahatan','Kecamatan','label','nama'].find(x=>k.includes(x))||k[0], value:['Jumlah','Nilai','Nilai_Rata_Rata','Total','value','count'].find(x=>k.includes(x))||k[1]}; }

        async function loadCharts() {
            if(chartsLoaded) return;
            const barOpts = { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} };
            const lineOpts = { responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, interaction:{mode:'index',intersect:false}, scales:{y:{beginAtZero:false, grid:{borderDash:[2,4]}},x:{grid:{display:false}}} };
            const charts = [{id:'chartBidang', url:'Data/JumlahBidangTanah.json', type:'pie', opts:{responsive:true, maintainAspectRatio:false}}, {id:'chartNTZ', url:'Data/StatistikNTZ.json', type:'bar', opts:{...barOpts, indexAxis:'y'}, color:'#10B981'}, {id:'chartNTK', url:'Data/StatistikNTK.json', type:'bar', opts:barOpts, color:'#6366F1'}, {id:'chartKejahatan', url:'Data/Kejahatan.json', type:'bar', opts:barOpts, color:'#334155'}];
            for(const c of charts) { try { const res = await fetch(c.url); const data = await res.json(); 
                if(c.id === 'chartBidang') {
                    // FILTER KHUSUS PIE CHART
                    const {label, value} = detectKeys(data);
                    const kelurahanValid = ["DANUKUSUMAN", "JAYENGAN", "JOYOTAKAN", "KEMLAYAN", "KRATONAN", "SERENGAN", "TIPES"];
                    const filteredData = data.filter(d => {
                        const l = d[label];
                        return l && l !== "Total" && isNaN(l) && (kelurahanValid.includes(l.toUpperCase()) || l.length > 2); 
                    });
                    
                    const vals = filteredData.map(d=>d[value]);
                    chartInstances[c.id] = new Chart(document.getElementById(c.id), {
                        type: c.type, 
                        data: {
                            labels: filteredData.map(d=>d[label]), 
                            datasets: [{data: vals, backgroundColor: c.color||['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6','#EC4899','#6366F1']}]
                        }, 
                        options: {
                            ...c.opts,
                            plugins: {
                                ...c.opts.plugins,
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            let value = context.parsed;
                                            let total = context.chart._metasets[context.datasetIndex].total;
                                            let percentage = (value / total * 100).toFixed(1) + '%';
                                            return label + value + ' (' + percentage + ')';
                                        }
                                    }
                                }
                            }
                        }
                    });
                } else {
                    const {label, value} = detectKeys(data);
                    if(label&&value) {
                        const vals = c.type==='pie'?data.map(d=>d[value]):data.map(d=>cleanCurrency(d[value])); 
                        chartInstances[c.id] = new Chart(document.getElementById(c.id), {type:c.type, data:{labels:data.map(d=>d[label]), datasets:[{data:vals, backgroundColor:c.color||['#3B82F6','#10B981','#F59E0B','#EF4444','#8B5CF6']}]}, options:c.opts});
                    }
                }
            } catch(e){} }
            try { const res=await fetch('Data/SuhuMean.json'); const r=await res.json(); let b=29; if(r.length>0) b=r[0].SuhuMean||29; chartInstances.suhu=new Chart(document.getElementById('chartSuhu'),{type:'line',data:{labels:['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'],datasets:[{label:'Suhu',data:[0,-0.2,0.2,0.5,0.8,1.2,1.5,1.4,1,0.5,0.2,0].map(v=>parseFloat(b)+v),borderColor:'#EF4444',tension:0.4,fill:true}]},options:lineOpts}); } catch(e){}
            chartsLoaded = true;
        }
        function reloadCharts(){ chartsLoaded=false; Object.values(chartInstances).forEach(c=>c&&c.destroy()); loadCharts(); showToast("Grafik Diperbarui","success"); }
        function switchView(v){ const m=document.getElementById('view-map'), d=document.getElementById('view-dashboard'), bm=document.getElementById('btn-map'), bd=document.getElementById('btn-dashboard'); if(v==='map'){m.classList.remove('hidden');d.classList.add('hidden');bm.classList.add('active');bd.classList.remove('active');setTimeout(()=>map.invalidateSize(),200);} else{m.classList.add('hidden');d.classList.remove('hidden');bd.classList.add('active');bm.classList.remove('active');loadCharts();} }
        function toggleLayer(n){ if(n==='analisis'){ const g=layers.analisis; if(map.hasLayer(g)){map.removeLayer(g); showToast("Analisis Off"); document.getElementById('route-info').classList.add('hidden');} else{map.addLayer(g); showToast("Analisis On","success");} } else { const l=layers[n]; if(map.hasLayer(l)){map.removeLayer(l); showToast(n+" Off");} else{map.addLayer(l); if(l.getBounds().isValid()) map.fitBounds(l.getBounds()); showToast(n+" On","success");} } }
    </script>
</body>
</html>